---
- name: Deploy BGInfo files and configure User Logon GPO (srv-work only)
  hosts: srv-work
  gather_facts: yes
  tasks:
    - name: Ensure NETLOGON bginfo folder exists
      win_file:
        path: C:\Windows\SYSVOL\sysvol\work.local\scripts\bginfo
        state: directory

    - name: Download BGInfo.exe into NETLOGON bginfo folder
      win_get_url:
        url: "https://www.dropbox.com/scl/fi/7di71bkr96osmuuy54sxl/Bginfo.exe?rlkey=kjxoykquz24rl9ihmkat02vvk&st=6ax9kmr3&dl=1"
        dest: C:\Windows\SYSVOL\sysvol\work.local\scripts\bginfo\BGInfo.exe
        validate_certs: no

    - name: Download bg_config.bgi into NETLOGON bginfo folder
      win_get_url:
        url: "https://www.dropbox.com/scl/fi/h8h62xqklzq3i7h7rtpdk/bg_config.bgi?rlkey=kjxoykquz24rl9ihmkat02vvk&st=6ax8qsjr&dl=1"
        dest: C:\Windows\SYSVOL\sysvol\work.local\scripts\bginfo\bg_config.bgi
        validate_certs: no

    - name: Download wallpaper.jpg into NETLOGON bginfo folder
      win_get_url:
        url: "https://www.dropbox.com/scl/fi/5g6jh7gyn85h5mbqajk7q/wallpaper.jpg?rlkey=kjxoykquz24rl9ihmkat02vvk&st=6ax9l5y8&dl=1"
        dest: C:\Windows\SYSVOL\sysvol\work.local\scripts\bginfo\wallpaper.jpg
        validate_certs: no

    - name: Download apply_bgi.bat into NETLOGON bginfo folder
      win_get_url:
        url: "https://www.dropbox.com/scl/fi/0xlbt2zdyz7x9cu9lwmmq/apply_bgi.bat?rlkey=kjxoykquz24rl9ihmkat02vvk&st=6ax9mxkk&dl=1"
        dest: C:\Windows\SYSVOL\sysvol\work.local\scripts\bginfo\apply_bgi.bat
        validate_certs: no

    - name: Create or get GPO named 'User Logon BGInfo' and set User Logon Script
      win_shell: |
        Import-Module GroupPolicy

        $GpoName = "User Logon BGInfo"
        $gpo = Get-GPO -Name $GpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $GpoName
        }

        # Link the GPO to the domain root (adjust your domain path here)
        $domainDN = "DC=work,DC=local"

        $links = Get-GPOLink -Domain $domainDN
        if (-not ($links | Where-Object { $_.GPOName -eq $GpoName })) {
          New-GPLink -Name $GpoName -Target $domainDN -LinkEnabled Yes
        }

        # Set the logon script path (UNC)
        $scriptPath = "\\srv-work\NETLOGON\bginfo\apply_bgi.bat"

        # Prepare logon scripts folder path
        $logonScriptPath = Join-Path $env:SystemRoot ("SYSVOL\sysvol\work.local\Policies\$($gpo.Id)\User\Scripts\Logon")
        if (-not (Test-Path $logonScriptPath)) {
          New-Item -ItemType Directory -Path $logonScriptPath -Force | Out-Null
        }

        # Write Scripts.ini file
        $iniFile = Join-Path $logonScriptPath "Scripts.ini"
        "[Logon]" | Out-File -FilePath $iniFile -Encoding ASCII -Force
        "0CmdLine=$scriptPath" | Out-File -FilePath $iniFile -Encoding ASCII -Append
        "0Parameters=" | Out-File -FilePath $iniFile -Encoding ASCII -Append
      args:
        executable: powershell.exe
