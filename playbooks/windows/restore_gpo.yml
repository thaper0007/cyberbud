---
- name: Restore GPOs from backup folder
  hosts: "{{ target_host }}"
  gather_facts: yes

  tasks:
    - name: Check if backup folder exists
      ansible.windows.win_stat:
        path: "{{ backup_folder }}"
      register: backup_folder_stat

    - name: Fail if backup folder does not exist
      ansible.builtin.fail:
        msg: "Backup folder {{ backup_folder }} does not exist!"
      when: not backup_folder_stat.stat.exists

    - name: Restore all GPOs from backup folder
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $backupPath = '{{ backup_folder }}'
        $backupGUIDs = Get-ChildItem -Path $backupPath -Directory | Where-Object { $_.Name -match '^\{.*\}$' } | Select-Object -ExpandProperty Name
        foreach ($guid in $backupGUIDs) {
          Restore-GPO -BackupId $guid -Path $backupPath
        }
      args:
        executable: powershell.exe

    - name: Confirm restoration completed
      debug:
        msg: "GPOs restored from {{ backup_folder }} on {{ target_host }}"
